- name: Set facts from .envrc
  set_fact:
    "{{item}}": "{{ lookup('env', '{{ item }}') }}"
  with_items:
    - ssh_rsa
    - ssh_ed25519
    - domain
    - gateway
    - user
    - passwd
    - crypted_pass
    - email
  # vars:
  #   envrc: {}

# - debug:
#     var: '{{item}}'
#   with_items:
#     # - 'a'
#     # - 'b'
#     # - 'c'
#     - ssh_rsa
#     - ssh_ed25519
#     - domain
#     - gateway
#     - user
#     - passwd
#     - crypted_pass
#     - email

# - debug: msg="item.item={{item.item}}, item.stdout={{item.stdout}}"
#   with_items: "{{envrc.results}}"

- name: Ensure folder structure exists
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ role_path }}/files/"
    - "{{ role_path }}/files/data/"
    - "{{ role_path }}/files/data/cloud-init/"
    - "{{ role_path }}/files/data/iso/"
    - "{{ role_path }}/files/data/os/"
    - "{{ role_path }}/files/data/pxe-config/"

- name: Download ISO
  get_url:
    url: "{{ iso_url }}"
    dest: "{{ role_path }}/files/data/iso/{{ iso_url | basename }}"
    checksum: "{{ iso_checksum }}"
  register: iso

- name: Extract the ISO
  become: yes
  command:
    cmd: "xorriso -osirrox on -indev {{ iso.dest }} -extract / {{ role_path }}/files/data/os"
    creates: "{{ role_path }}/files/data/os/.treeinfo"

# ref: https://askubuntu.com/questions/1235723/automated-20-04-server-installation-using-pxe-and-live-server-image
- name: Download signed grub netboot EFI
  get_url:
    url: "http://archive.ubuntu.com/ubuntu/dists/focal-updates/main/uefi/grub2-amd64/current/grubnetx64.efi.signed"
    dest: "{{ role_path }}/files/data/pxe-config/grubnetx64.efi.signed"
    checksum: "sha256:442a13ce54100d4f51b1ec68d495a6eacf9fd06b862ed3ed51ec5ae159f18f84"
  # register: efi

# chmod -R +w iso {{ role_path }}/files/data/os

# # Create empty meta-data file:
# touch iso/nocloud/meta-data

# # Copy user-data file:
# cp user-data iso/nocloud/user-data

- debug:
    var: "{{item}}"
  with_items:
    - ansible_default_ipv4.address
    - ansible_default_ipv4.broadcast
    - ansible_default_ipv4.gateway
    - ansible_default_ipv4.netmask
    - ansible_default_ipv4.network

- name: Render DHCP config
  template:
    src: dhcpd.conf.j2
    dest: "{{ role_path }}/files/data/pxe-config/dhcpd.conf"
    # dest: "{{ role_path }}/files/dhcp/dhcpd.conf"
    mode: 0644

- name: Render GRUB config
  template:
    src: grub.cfg.j2
    dest: "{{ role_path }}/files/data/pxe-config/grub.cfg"
    mode: 0644

- name: Render default cloudinit meta-data
  template:
    src: meta-data.j2
    dest: "{{ role_path }}/files/data/cloud-init/meta-data"
    mode: 0644

- name: Render default cloudinit user-data
  template:
    src: generic-user-data.j2
    dest: "{{ role_path }}/files/data/cloud-init/user-data"
    mode: 0644

# - name: Render machine specific init config
#   template:
#     src: kickstart.ks.j2
#     dest: "{{ role_path }}/files/data/init-config/{{ hostvars[item]['mac'] }}.ks"
#     mode: 0644
#   loop: "{{ groups['metal'] }}"

# - name: Render machine specific cloudinit meta-data
#   template:
#     src: meta-data.j2
#     dest: "{{ role_path }}/data/files/cloud-init/{{ hostvars[item]["mac"] }}/meta-data"
#     mode: 0644
#   loop: "{{ groups['metal'] }}"

# - name: Render machine specific cloudinit user-data
#   template:
#     src: user-data.j2
#     dest: "{{ role_path }}/data/files/cloud-init/{{ hostvars[item]["mac"] }}/user-data"
#     mode: 0644
#   loop: "{{ groups['metal'] }}"

- name: Start ephemeral PXE server
  docker_compose:
    project_src: "{{ role_path }}/files"
    state: present
    restarted: true
    build: true
